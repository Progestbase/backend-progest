# üìò Guia R√°pido - API Unidades

## üîó Base URL

```
http://localhost:8000/api
```

---

## üìç Rotas Dispon√≠veis

### 1Ô∏è‚É£ **Criar Unidade**

```http
POST /unidades/add
```

**Body (JSON):**

```json
{
    "unidades": {
        "polo_id": 1,
        "nome": "Farm√°cia Central",
        "descricao": "Farm√°cia principal do hospital",
        "status": "A",
        "estoque": true,
        "tipo": "Medicamento"
    }
}
```

**Campos:**

-   `polo_id` ‚ö†Ô∏è **obrigat√≥rio** - ID do polo
-   `nome` ‚ö†Ô∏è **obrigat√≥rio** - Nome da unidade
-   `descricao` - Descri√ß√£o (opcional)
-   `status` - `"A"` (Ativo) ou `"I"` (Inativo) - padr√£o: `"A"`
-   `estoque` - `true` ou `false` - padr√£o: `false`
-   `tipo` - `"Medicamento"` ou `"Material"` - padr√£o: `"Material"`

**Response (Sucesso - 200):**

```json
{
    "status": true,
    "data": {
        "id": 1,
        "polo_id": 1,
        "nome": "FARM√ÅCIA CENTRAL",
        "descricao": "Farm√°cia principal do hospital",
        "status": "A",
        "estoque": true,
        "tipo": "Medicamento",
        "created_at": "2025-10-06T...",
        "updated_at": "2025-10-06T..."
    }
}
```

**Response (Erro - 422):**

```json
{
    "status": false,
    "validacao": true,
    "erros": {
        "polo_id": ["O campo polo id √© obrigat√≥rio."]
    }
}
```

---

### 2Ô∏è‚É£ **Atualizar Unidade**

```http
POST /unidades/update
```

**Body (JSON):**

```json
{
    "unidades": {
        "id": 1,
        "polo_id": 1,
        "nome": "Farm√°cia Central Atualizada",
        "descricao": "Nova descri√ß√£o",
        "status": "A",
        "estoque": true,
        "tipo": "Medicamento"
    }
}
```

**Campos:** Mesmos do `add` + `id` obrigat√≥rio

**Response (Sucesso - 200):**

```json
{
    "status": true,
    "data": {
        "id": 1,
        "polo_id": 1,
        "nome": "FARM√ÅCIA CENTRAL ATUALIZADA",
        "status": "A",
        "estoque": true,
        "tipo": "Medicamento"
    }
}
```

**Response (Erro - 404):**

```json
{
    "status": false,
    "message": "Unidade n√£o encontrada."
}
```

---

### 3Ô∏è‚É£ **Listar Todas as Unidades**

```http
POST /unidades/list
```

**Body (JSON) - Sem filtros:**

```json
{}
```

**Body (JSON) - Com filtros:**

```json
{
    "filters": [
        { "tipo": "Medicamento" },
        { "status": "A" },
        { "estoque": true }
    ]
}
```

**Body (JSON) - Com pagina√ß√£o:**

```json
{
    "paginate": true,
    "per_page": 20
}
```

**Body (JSON) - Filtros + Pagina√ß√£o:**

```json
{
    "filters": [{ "tipo": "Medicamento" }, { "status": "A" }],
    "paginate": true,
    "per_page": 15
}
```

**Response (Sucesso - 200):**

```json
{
    "status": true,
    "data": [
        {
            "id": 1,
            "polo_id": 1,
            "nome": "FARM√ÅCIA CENTRAL",
            "descricao": "Farm√°cia principal",
            "status": "A",
            "estoque": true,
            "tipo": "Medicamento",
            "polo": {
                "id": 1,
                "nome": "Hospital Geral",
                "status": "A"
            }
        },
        {
            "id": 2,
            "polo_id": 2,
            "nome": "ALMOXARIFADO GERAL",
            "descricao": "Almoxarifado de materiais",
            "status": "A",
            "estoque": true,
            "tipo": "Material",
            "polo": {
                "id": 2,
                "nome": "Hospital Afr√¢nio Peixoto",
                "status": "A"
            }
        }
    ]
}
```

**Response com Pagina√ß√£o:**

```json
{
  "status": true,
  "data": {
    "current_page": 1,
    "data": [...],
    "first_page_url": "http://localhost:8000/api/unidades/list?page=1",
    "from": 1,
    "last_page": 3,
    "last_page_url": "http://localhost:8000/api/unidades/list?page=3",
    "next_page_url": "http://localhost:8000/api/unidades/list?page=2",
    "path": "http://localhost:8000/api/unidades/list",
    "per_page": 20,
    "prev_page_url": null,
    "to": 20,
    "total": 45
  }
}
```

---

### 4Ô∏è‚É£ **Obter Uma Unidade Espec√≠fica**

```http
POST /unidades/listData
```

**Body (JSON):**

```json
{
    "id": 1
}
```

**Response (Sucesso - 200):**

```json
{
    "status": true,
    "data": {
        "id": 1,
        "polo_id": 1,
        "nome": "FARM√ÅCIA CENTRAL",
        "descricao": "Farm√°cia principal do hospital",
        "status": "A",
        "estoque": true,
        "tipo": "Medicamento",
        "created_at": "2025-10-06T10:30:00.000000Z",
        "updated_at": "2025-10-06T10:30:00.000000Z",
        "polo": {
            "id": 1,
            "nome": "Hospital Geral",
            "status": "A",
            "created_at": "2025-10-06T10:00:00.000000Z",
            "updated_at": "2025-10-06T10:00:00.000000Z"
        }
    }
}
```

**Response (Erro - 404):**

```json
{
    "status": false,
    "message": "Unidade n√£o encontrada."
}
```

---

### 5Ô∏è‚É£ **Deletar Unidade**

```http
POST /unidades/delete/{id}
```

**Exemplo:**

```http
POST /unidades/delete/1
```

**Sem body necess√°rio**

**Response (Sucesso - 200):**

```json
{
    "status": true,
    "message": "Unidade exclu√≠da com sucesso."
}
```

**Response (Erro - 404):**

```json
{
    "status": false,
    "message": "Unidade n√£o encontrada."
}
```

**Response (Erro - 422 - Tem v√≠nculos):**

```json
{
    "status": false,
    "message": "N√£o √© poss√≠vel excluir esta unidade pois ela possui registros relacionados no sistema.",
    "references": [
        "estoque (15 itens)",
        "movimenta√ß√µes de origem (3)",
        "movimenta√ß√µes de destino (7)"
    ]
}
```

---

### 6Ô∏è‚É£ **Alternar Status (A ‚Üî I)** ‚≠ê NOVO

```http
POST /unidades/toggleStatus
```

**Body (JSON):**

```json
{
    "id": 1
}
```

**Response (Sucesso - 200):**

```json
{
    "status": true,
    "data": {
        "id": 1,
        "polo_id": 1,
        "nome": "FARM√ÅCIA CENTRAL",
        "descricao": "...",
        "status": "I",
        "estoque": true,
        "tipo": "Medicamento",
        "created_at": "2025-10-06T10:30:00.000000Z",
        "updated_at": "2025-10-06T15:45:00.000000Z"
    },
    "message": "Status atualizado com sucesso"
}
```

**Response (Erro - 400):**

```json
{
    "status": false,
    "message": "ID da unidade n√£o fornecido"
}
```

**Response (Erro - 404):**

```json
{
    "status": false,
    "message": "Unidade n√£o encontrada"
}
```

---

## üéØ Valida√ß√µes

| Campo       | Regras                                     |
| ----------- | ------------------------------------------ |
| `polo_id`   | Obrigat√≥rio, deve existir na tabela `polo` |
| `nome`      | Obrigat√≥rio, m√°x 255 caracteres            |
| `tipo`      | Apenas `"Medicamento"` ou `"Material"`     |
| `status`    | Apenas `"A"` ou `"I"`                      |
| `estoque`   | Booleano (`true`/`false`)                  |
| `descricao` | Opcional, texto livre                      |

---

## ‚ö†Ô∏è Regras de Neg√≥cio

### 1. **Prote√ß√£o de Delete**

N√£o pode deletar unidade que possui:

-   ‚ùå Itens no estoque
-   ‚ùå Movimenta√ß√µes como origem
-   ‚ùå Movimenta√ß√µes como destino

### 2. **Auto-convers√£o**

-   Nome √© convertido automaticamente para **MAI√öSCULAS**
-   Exemplo: `"farm√°cia"` ‚Üí `"FARM√ÅCIA"`

### 3. **Tipo Importante**

-   Define quais produtos aparecem no estoque da unidade
-   `tipo: "Medicamento"` ‚Üí apenas produtos de grupos tipo "Medicamento"
-   `tipo: "Material"` ‚Üí apenas produtos de grupos tipo "Material"

### 4. **Flag Estoque**

-   `estoque: true` ‚Üí Unidade controla estoque (Observer cria registros automaticamente)
-   `estoque: false` ‚Üí Unidade n√£o controla estoque

### 5. **Relacionamento com Polo**

-   Sempre retorna dados do polo junto (`eager loading`)
-   Polo deve existir e estar ativo

---

## üì¶ Exemplos de Uso

### JavaScript (Axios)

```javascript
import axios from "axios";

const API_URL = "http://localhost:8000/api";

// ‚úÖ Criar unidade
const criarUnidade = async () => {
    try {
        const response = await axios.post(`${API_URL}/unidades/add`, {
            unidades: {
                polo_id: 1,
                nome: "Farm√°cia Central",
                estoque: true,
                tipo: "Medicamento",
            },
        });

        console.log("‚úÖ Unidade criada:", response.data.data);
    } catch (error) {
        console.error("‚ùå Erro:", error.response.data);
    }
};

// ‚úÖ Listar com filtros
const listarUnidades = async () => {
    const response = await axios.post(`${API_URL}/unidades/list`, {
        filters: [{ tipo: "Medicamento" }, { status: "A" }],
        paginate: true,
        per_page: 20,
    });

    return response.data.data;
};

// ‚úÖ Obter uma unidade
const obterUnidade = async (id) => {
    const response = await axios.post(`${API_URL}/unidades/listData`, {
        id: id,
    });

    return response.data.data;
};

// ‚úÖ Atualizar unidade
const atualizarUnidade = async (id) => {
    const response = await axios.post(`${API_URL}/unidades/update`, {
        unidades: {
            id: id,
            polo_id: 1,
            nome: "Farm√°cia Central Atualizada",
            status: "A",
            estoque: true,
            tipo: "Medicamento",
        },
    });

    return response.data.data;
};

// ‚úÖ Toggle status (A ‚Üî I)
const toggleStatus = async (id) => {
    const response = await axios.post(`${API_URL}/unidades/toggleStatus`, {
        id: id,
    });

    console.log("‚úÖ Status alterado:", response.data.data.status);
};

// ‚úÖ Deletar unidade
const deletarUnidade = async (id) => {
    try {
        const response = await axios.post(`${API_URL}/unidades/delete/${id}`);
        console.log("‚úÖ Unidade deletada");
    } catch (error) {
        if (error.response.status === 422) {
            console.error(
                "‚ùå Unidade possui v√≠nculos:",
                error.response.data.references
            );
        }
    }
};
```

---

### React Hook (Exemplo)

```jsx
import { useState, useEffect } from "react";
import axios from "axios";

const useUnidades = () => {
    const [unidades, setUnidades] = useState([]);
    const [loading, setLoading] = useState(false);

    const listar = async (filtros = {}) => {
        setLoading(true);
        try {
            const response = await axios.post("/api/unidades/list", {
                filters: filtros.filters || [],
                paginate: filtros.paginate,
                per_page: filtros.per_page || 50,
            });
            setUnidades(response.data.data);
        } catch (error) {
            console.error("Erro ao listar unidades:", error);
        } finally {
            setLoading(false);
        }
    };

    const criar = async (dadosUnidade) => {
        const response = await axios.post("/api/unidades/add", {
            unidades: dadosUnidade,
        });
        return response.data.data;
    };

    const atualizar = async (id, dadosUnidade) => {
        const response = await axios.post("/api/unidades/update", {
            unidades: { ...dadosUnidade, id },
        });
        return response.data.data;
    };

    const toggleStatus = async (id) => {
        const response = await axios.post("/api/unidades/toggleStatus", { id });
        return response.data.data;
    };

    const deletar = async (id) => {
        await axios.post(`/api/unidades/delete/${id}`);
    };

    return {
        unidades,
        loading,
        listar,
        criar,
        atualizar,
        toggleStatus,
        deletar,
    };
};

export default useUnidades;
```

---

## ‚úÖ Status HTTP

| C√≥digo  | Significado                                 |
| ------- | ------------------------------------------- |
| **200** | ‚úÖ Sucesso                                  |
| **400** | ‚ö†Ô∏è Requisi√ß√£o inv√°lida (falta par√¢metro)    |
| **404** | ‚ùå Unidade n√£o encontrada                   |
| **422** | ‚ö†Ô∏è Erro de valida√ß√£o ou v√≠nculos existentes |
| **500** | üî• Erro interno do servidor                 |

---

## üé® Padr√£o de Response

### ‚úÖ Sucesso

```json
{
  "status": true,
  "data": { ... },
  "message": "Mensagem opcional"
}
```

### ‚ùå Erro

```json
{
    "status": false,
    "message": "Descri√ß√£o do erro"
}
```

### ‚ö†Ô∏è Erro de Valida√ß√£o

```json
{
    "status": false,
    "validacao": true,
    "erros": {
        "campo": ["Mensagem de erro"]
    }
}
```

---

## üîç Filtros Dispon√≠veis

Os filtros funcionam como **AND** (todas as condi√ß√µes devem ser verdadeiras):

```json
{
    "filters": [
        { "tipo": "Medicamento" },
        { "status": "A" },
        { "estoque": true },
        { "polo_id": 1 }
    ]
}
```

**Campos filtr√°veis:**

-   `id`
-   `polo_id`
-   `nome`
-   `status`
-   `estoque`
-   `tipo`

---

## üìä Tipos de Unidade

| Tipo          | Descri√ß√£o                            | Produtos Permitidos                          |
| ------------- | ------------------------------------ | -------------------------------------------- |
| `Medicamento` | Unidade de medicamentos (Farm√°cias)  | Apenas produtos de grupos tipo "Medicamento" |
| `Material`    | Unidade de materiais (Almoxarifados) | Apenas produtos de grupos tipo "Material"    |

---

## üí° Dicas

1. **Sempre valide o response** - Verifique `status: true` antes de processar
2. **Use eager loading** - A API j√° retorna o polo junto (otimizado)
3. **Trate erros 422** - Podem indicar valida√ß√µes ou v√≠nculos
4. **Toggle √© mais simples** - Use em vez de update s√≥ para status
5. **Pagina√ß√£o recomendada** - Use para listas grandes (>50 itens)

---

## üêõ Troubleshooting

### Erro: "polo_id √© obrigat√≥rio"

```json
// ‚ùå Errado
{ "unidades": { "nome": "Teste" } }

// ‚úÖ Correto
{ "unidades": { "polo_id": 1, "nome": "Teste" } }
```

### Erro 422 ao deletar

```json
// Verifique os v√≠nculos em response.data.references
// Remova estoque e movimenta√ß√µes antes de deletar
```

---

## üìû Suporte

-   **Backend:** Laravel 8
-   **Auth:** Sanctum (maioria das rotas n√£o requer auth)
-   **Documenta√ß√£o:** `/docs/API-UNIDADES.md`
