services:
    # --- MySQL Database ---
    mysql:
        image: mysql:8.0
        environment:
            - MYSQL_DATABASE=progest
            - MYSQL_USER=progest
            - MYSQL_PASSWORD=${DB_PASSWORD:-progest_secret}
            - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-root_secret}
        volumes:
            - mysql_data:/var/lib/mysql
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s
        networks:
            - progest-network
        restart: unless-stopped

    # --- Backend Laravel API ---
    progest-api:
        build:
            context: .
            dockerfile: Dockerfile
        image: progest-api:latest
        env_file:
            - ./.env.api
        depends_on:
            mysql:
                condition: service_healthy
        networks:
            - progest-network
            - traefik-public
        restart: unless-stopped
        labels:
            - "traefik.enable=true"
            # IMPORTANTE: Especificar qual rede o Traefik deve usar
            - "traefik.docker.network=traefik-public"
            # Configuração do DOMÍNIO DA API
            - "traefik.http.routers.progest-api.rule=Host(`hgvcprogrest-api.davidjunior.dev.br`)"
            - "traefik.http.routers.progest-api.entrypoints=web"
            # Middleware CORS
            - "traefik.http.routers.progest-api.middlewares=progest-cors"
            - "traefik.http.middlewares.progest-cors.headers.accesscontrolallowmethods=GET,POST,PUT,PATCH,DELETE,OPTIONS"
            - "traefik.http.middlewares.progest-cors.headers.accesscontrolallowheaders=*"
            - "traefik.http.middlewares.progest-cors.headers.accesscontrolalloworiginlist=*"
            - "traefik.http.middlewares.progest-cors.headers.accesscontrolmaxage=100"
            - "traefik.http.middlewares.progest-cors.headers.addvaryheader=true"
            # Porta interna onde a API roda (80)
            - "traefik.http.services.progest-api.loadbalancer.server.port=80"

# --- Volumes ---
volumes:
    mysql_data:

# --- Networks ---
networks:
    progest-network: {}
    traefik-public:
        external: true
