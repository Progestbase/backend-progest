name: CD Backend - Deploy with Docker

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Production
    steps:
      - name: âš™ï¸ Checkout do RepositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ›‘ Parar containers antigos
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            if [ -d "./progest/backend-progest" ]; then
              cd ./progest/backend-progest
              echo "ğŸ›‘ Parando containers..."
              docker-compose down || true
            fi

      - name: ğŸ“¦ Transferir arquivos via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          source: "."
          target: "./progest/backend-progest"
          overwrite: true
          strip_components: 0

      - name: ğŸš€ Executar Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ./progest/backend-progest

            echo "ğŸ“‹ Arquivos transferidos:"
            ls -la

            echo "ğŸ“‹ Verificando Makefile..."
            if [ ! -f Makefile ]; then
              echo "âŒ Makefile nÃ£o encontrado!"
              ls -la
              exit 1
            fi

            echo "ğŸ”§ Verificando .env.api..."
            if [ ! -f .env.api ]; then
              echo "âš ï¸ Arquivo .env.api nÃ£o encontrado, criando a partir do exemplo..."
              if [ -f .env.api.example ]; then
                cp .env.api.example .env.api
                echo "ğŸ“ .env.api criado - LEMBRE-SE DE CONFIGURAR AS VARIÃVEIS!"
              fi
            fi

            echo "ğŸš€ Executando make deploy..."
            make deploy

            echo "ğŸ“Š Containers ativos:"
            docker ps | grep progest || echo "Nenhum container rodando ainda..."

            echo "âœ… Deploy do Backend concluÃ­do com sucesso!"
